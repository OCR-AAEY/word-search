name: Build and Push Docker Image

on:
  push:
    paths:
      - '.github/docker/**.Dockerfile'   # Trigger only when Dockerfiles are changed
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Find modified Dockerfiles
        id: dockerfiles
        run: |
          # List all Dockerfiles modified in this push
          FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '\.github/docker/.*\.Dockerfile$' || true)
          echo "Modified Dockerfiles: $FILES"
          # Convert to JSON array for matrix usage
          JSON=$(echo "$FILES" | jq -R -s -c 'split("\n")[:-1]')
          echo "dockerfiles=$JSON" >> $GITHUB_OUTPUT

      - name: Build and Push Images
        run: |
          for file in ${{ steps.dockerfiles.outputs.dockerfiles }}; do
            # Extract image name from Dockerfile filename
            IMAGE_NAME=$(basename "$file" .Dockerfile)
            IMAGE_BASE=ghcr.io/ocr-aaey/$IMAGE_NAME
            COMMIT_TAG=${GITHUB_SHA::8}

            echo "Building image $IMAGE_BASE from $file"

            # Build and tag image
            docker build -t $IMAGE_BASE:latest -t $IMAGE_BASE:$COMMIT_TAG -f "$file" .

            # Push both tags
            docker push $IMAGE_BASE:latest
            docker push $IMAGE_BASE:$COMMIT_TAG
          done