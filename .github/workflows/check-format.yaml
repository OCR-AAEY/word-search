name: Check format

on:
  push:

jobs:

  check-format:
    name: Check format
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/ocr-aaey/ci-format:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GHCR_PAT }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check format
        shell: bash
        run: |
          SRC_FILES="$(find ./src/ -type f \( -name '*.c' -o -name '*.h' \))"
          BAD_FILES=""

          for f in $SRC_FILES; do
            if ! clang-format --dry-run --Werror "$f"; then
              BAD_FILES="$BAD_FILES$f\n"
            fi
          done

          if [[ -n "$BAD_FILES" ]]; then
            echo "The following files are not properly formatted:"
            printf "$BAD_FILES"
            exit 1
          fi
